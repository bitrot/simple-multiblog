{% extends "admin_template.html" %}

{% block head %}
    <script src="{{ url_for('static', filename='js/epiceditor.js') }}" type="text/javascript"></script>
    <script type="text/javascript">
        var editor = null;
        $(document).ready(function() {
            var opts = {
                container: 'post_content',
                basePath: "{{ url_for('static', filename='epiceditor/') }}",
                localStorageName: 'epiceditor_{{post.id}}',
                parser: marked,
                file: {
                    name: 'epiceditor_{{post.id}}',
                    defaultContent: "{{ post.text|regex('\"', '\\\"')|regex('[\n\r]', '\\\" + \\\"') }}",
                    autoSave: 100
                },
                theme: {
                    base:'/themes/base/epiceditor.css',
                    preview:'/themes/preview/preview-dark.css',
                    editor:'/themes/editor/epic-dark.css'
                },
                focusOnLoad: false,
                shortcut: {
                    modifier: 18,
                    fullscreen: 70,
                    preview: 80,
                    edit: 79
                }
            };

            editor = new EpicEditor(opts).load();

            // Store existing content in the browser
            editor.save(opts.defaultContent);

            $('#save').click(function (e) {
                $(this).val('Saving...');

                // Epic editor save
                editor.save();

                // Simple MB save
                SavePost();

                $(this).val('Saved');
                setTimeout("$(this).val('Save');", 2000);
                e.preventDefault();
                return false;
            });

        {% if post.draft %}
            setTimeout("SaveTick();", 10000);
        });

        function SaveTick() {
            elem = editor.getElement('editor').body;
            issueSaveAjax({{ post.id }}, false, elem);
            setTimeout("SaveTick()", 10000);
        }
        {% else %}
        });

        function SavePost() {
            elem = editor.getElement('editor').body;
            issueSaveAjax({{ post.id }}, false, elem);
        }
        {% endif %}
    </script>
{% endblock %}

{% block content %}

        <form accept-charset="UTF-8" action="" class="edit_post" id="edit_post_{{ post.id }}" method="post">
            <div class="contain">

                <div class="expandingArea text-title">
                    <textarea cols="40" id="post_title" name="post_title" placeholder="Title here" rows="1">{{ post.title }}</textarea>
                </div>
                <fieldset class="markdown">
                    <div id="post_content" class="expandingArea text-content" style="height: 350px;">
                        <!--<textarea cols="40" id="post_content" name="post_content" placeholder="Write post here" rows="20">{{ post.text }}</textarea>-->
                    </div>
                </fieldset>
            </div>
            <div id="publish-bar">
                <div class="contain">
                    <div class="left">
                        <a href="{{ url_for('admin') }}">&laquo; Admin</a>
                        <a href="{{ url_for('delete', id=post.id, next="admin" ) }}" class="delete-bar" data-confirm="Are you sure?" rel="nofollow">Delete</a>
                    </div>
                    <div class="right">
                        <label for="post_draft">Draft</label>
                        <input name="post_draft" type="hidden" value="0" /><input id="post_draft" name="post_draft" type="checkbox" value="1" {% if post.draft %}checked{% endif %} />
                        {% if post.draft %}
                            <a href="#" onclick="issueSaveAjax({{ post.id }}, true); return false;" target="_blank">Preview</a>
                        {% else %}
                            <a href="{{  url_for('get_author_slug', author=post.author.username, slug=post.slug) }}" target="_blank">View live</a>
                        {% endif %}
                        <input id="save" name="commit" type="submit" value="Save" target="_blank"/>
                    </div>
                </div>
            </div>
        </form>
{% endblock %}